{
  "version": 3,
  "sources": ["../../../cloudflare-worker.js"],
  "sourceRoot": "C:\\Users\\User\\Downloads\\Aetherfalls-Lunarity\\.wrangler\\tmp\\deploy-XevDnF",
  "sourcesContent": ["// Cloudflare Worker entry point for Lunarity authentication + script delivery\r\n// Deploy with Wrangler and bind a KV namespace named \"SCRIPTS\" that stores:\r\n//   - loader.lua (GUI loader served at / or /loader)\r\n//   - lunarity.lua (combat script)\r\n//   - DoorESP.lua (ESP script)\r\n// Provide an API key map via the API_KEYS secret (JSON) and optional kill switch via KILL_SWITCH env var.\r\n\r\nconst CONFIG = {\r\n    loaderKvKey: \"loader.lua\",\r\n    tokenKvPrefix: \"whitelist:\",\r\n    loaderWhitelistTtl: 120, // seconds loader tokens stay valid before validation\r\n    sessionTtl: 600, // seconds granted after scripts validate successfully\r\n    scripts: {\r\n        lunarity: {\r\n            kvKey: \"lunarity.lua\",\r\n            label: \"Lunarity \u00B7 IFrames\",\r\n            description: \"Advanced combat enhancer with IFrames + Anti-Debuff\",\r\n            version: \"1.0.0\",\r\n            enabled: true,\r\n        },\r\n        doorEsp: {\r\n            kvKey: \"DoorESP.lua\",\r\n            label: \"Door ESP \u00B7 Halloween\",\r\n            description: \"ESP and Auto-Candy support for Halloween doors\",\r\n            version: \"1.0.0\",\r\n            enabled: true,\r\n        },\r\n    },\r\n};\r\n\r\n// API Keys Configuration - Edit this object directly to add/remove keys\r\n// No secrets or KV required - just modify this code and redeploy\r\nconst API_KEYS = {\r\n    \"demo-dev-key\": {\r\n        label: \"Developer\",\r\n        allowedScripts: [\"lunarity\", \"doorEsp\"],\r\n    },\r\n    \"test-key-123\": {\r\n        label: \"Tester\",\r\n        allowedScripts: [\"lunarity\", \"doorEsp\"],\r\n    },\r\n    // Add more keys here:\r\n    // \"your-custom-key\": {\r\n    //     label: \"Your Name\",\r\n    //     allowedScripts: [\"lunarity\", \"doorEsp\"],\r\n    // },\r\n};\r\n\r\nconst JSON_HEADERS = {\r\n    \"content-type\": \"application/json; charset=utf-8\",\r\n    \"cache-control\": \"no-store\",\r\n};\r\n\r\nfunction jsonResponse(body, init = {}) {\r\n    return new Response(JSON.stringify(body, null, 2), {\r\n        ...init,\r\n        headers: {\r\n            ...JSON_HEADERS,\r\n            ...(init.headers || {}),\r\n        },\r\n    });\r\n}\r\n\r\nfunction parseKeyring(env) {\r\n    // Always use the hardcoded API_KEYS object\r\n    return API_KEYS;\r\n}\r\n\r\nfunction normalizeKey(raw) {\r\n    return (raw || \"\").trim();\r\n}\r\n\r\nfunction buildScriptList(allowedIds) {\r\n    return allowedIds\r\n        .map((id) => {\r\n            const meta = CONFIG.scripts[id];\r\n            if (!meta || !meta.enabled) {\r\n                return null;\r\n            }\r\n            return {\r\n                id,\r\n                label: meta.label,\r\n                description: meta.description,\r\n                version: meta.version,\r\n            };\r\n        })\r\n        .filter(Boolean);\r\n}\r\n\r\nfunction randomToken(bytes = 16) {\r\n    const buf = new Uint8Array(bytes);\r\n    crypto.getRandomValues(buf);\r\n    return [...buf].map((b) => b.toString(16).padStart(2, \"0\")).join(\"\");\r\n}\r\n\r\nfunction buildTokenKey(token) {\r\n    return CONFIG.tokenKvPrefix + token;\r\n}\r\n\r\nasync function issueWhitelistToken(env, metadata) {\r\n    const token = randomToken();\r\n    const key = buildTokenKey(token);\r\n    await env.SCRIPTS.put(key, JSON.stringify({\r\n        scriptId: metadata.scriptId,\r\n        userId: metadata.userId,\r\n        username: metadata.username,\r\n        issuedAt: Date.now(),\r\n    }), { expirationTtl: CONFIG.loaderWhitelistTtl });\r\n    return { token, expiresIn: CONFIG.loaderWhitelistTtl };\r\n}\r\n\r\nasync function refreshWhitelistToken(env, token, record, ttl) {\r\n    const key = buildTokenKey(token);\r\n    await env.SCRIPTS.put(key, JSON.stringify(record), { expirationTtl: ttl });\r\n}\r\n\r\nasync function handleLoader(env) {\r\n    const source = await env.SCRIPTS.get(CONFIG.loaderKvKey, \"text\");\r\n    if (!source) {\r\n        return new Response(\"-- Loader not uploaded to KV (key: \" + CONFIG.loaderKvKey + \")\", {\r\n            status: 503,\r\n            headers: {\r\n                \"content-type\": \"text/plain; charset=utf-8\",\r\n                \"cache-control\": \"no-store\",\r\n            },\r\n        });\r\n    }\r\n    return new Response(source, {\r\n        headers: {\r\n            \"content-type\": \"text/plain; charset=utf-8\",\r\n            \"cache-control\": \"no-store\",\r\n        },\r\n    });\r\n}\r\n\r\nasync function handleAuthorize(request, env) {\r\n    const killSwitch = (env?.KILL_SWITCH || \"false\").toLowerCase() === \"true\";\r\n    if (killSwitch) {\r\n        return jsonResponse({ ok: false, reason: \"Global kill switch active.\" }, { status: 503 });\r\n    }\r\n\r\n    let body;\r\n    try {\r\n        body = await request.json();\r\n    } catch (err) {\r\n        return jsonResponse({ ok: false, reason: \"Invalid JSON payload.\" }, { status: 400 });\r\n    }\r\n\r\n    const keyring = parseKeyring(env);\r\n    const apiKey = normalizeKey(body.apiKey);\r\n    const keyEntry = keyring[apiKey];\r\n    if (!keyEntry) {\r\n        return jsonResponse({ ok: false, reason: \"Unauthorized: invalid API key.\" }, { status: 401 });\r\n    }\r\n\r\n    const allowedScripts = Array.isArray(keyEntry.allowedScripts) && keyEntry.allowedScripts.length > 0\r\n        ? keyEntry.allowedScripts\r\n        : Object.keys(CONFIG.scripts);\r\n\r\n    const responseBase = {\r\n        ok: true,\r\n        message: \"Authorization OK\",\r\n        scripts: buildScriptList(allowedScripts),\r\n        actor: {\r\n            label: keyEntry.label || \"User\",\r\n            userId: body.userId,\r\n            username: body.username,\r\n            placeId: body.placeId,\r\n        },\r\n    };\r\n\r\n    const scriptId = body.scriptId || body.script;\r\n    if (!scriptId) {\r\n        return jsonResponse(responseBase);\r\n    }\r\n\r\n    if (!allowedScripts.includes(scriptId)) {\r\n        return jsonResponse({ ok: false, reason: \"API key not permitted for this script.\" }, { status: 403 });\r\n    }\r\n\r\n    const scriptMeta = CONFIG.scripts[scriptId];\r\n    if (!scriptMeta || !scriptMeta.enabled) {\r\n        return jsonResponse({ ok: false, reason: \"Requested script is disabled.\" }, { status: 503 });\r\n    }\r\n\r\n    const scriptBody = await env.SCRIPTS.get(scriptMeta.kvKey, \"text\");\r\n    if (!scriptBody) {\r\n        return jsonResponse({ ok: false, reason: `Script body missing in KV (${scriptMeta.kvKey}).` }, { status: 500 });\r\n    }\r\n\r\n    const tokenInfo = await issueWhitelistToken(env, {\r\n        scriptId,\r\n        userId: body.userId,\r\n        username: body.username,\r\n    });\r\n\r\n    return jsonResponse({\r\n        ...responseBase,\r\n        script: scriptBody,\r\n        scriptMeta: {\r\n            id: scriptId,\r\n            label: scriptMeta.label,\r\n            description: scriptMeta.description,\r\n            version: scriptMeta.version,\r\n        },\r\n        accessToken: tokenInfo.token,\r\n        expiresIn: tokenInfo.expiresIn,\r\n        validatePath: \"/validate\",\r\n    });\r\n}\r\n\r\nfunction handleHealth() {\r\n    return jsonResponse({ ok: true });\r\n}\r\n\r\nasync function handleValidate(request, env) {\r\n    const killSwitch = (env?.KILL_SWITCH || \"false\").toLowerCase() === \"true\";\r\n    if (killSwitch) {\r\n        return jsonResponse({ ok: false, reason: \"Kill switch active\", killSwitch: true }, { status: 403 });\r\n    }\r\n\r\n    let body;\r\n    try {\r\n        body = await request.json();\r\n    } catch (_err) {\r\n        return jsonResponse({ ok: false, reason: \"Invalid JSON payload.\" }, { status: 400 });\r\n    }\r\n\r\n    const token = normalizeKey(body.token);\r\n    if (!token) {\r\n        return jsonResponse({ ok: false, reason: \"Token missing.\" }, { status: 400 });\r\n    }\r\n\r\n    const tokenKey = buildTokenKey(token);\r\n    const record = await env.SCRIPTS.get(tokenKey, { type: \"json\" });\r\n    if (!record) {\r\n        return jsonResponse({ ok: false, reason: \"Token expired or invalid.\" }, { status: 401 });\r\n    }\r\n\r\n    if (body.scriptId && record.scriptId && body.scriptId !== record.scriptId) {\r\n        return jsonResponse({ ok: false, reason: \"Token/script mismatch.\" }, { status: 403 });\r\n    }\r\n\r\n    const refresh = body.refresh !== false;\r\n    if (refresh) {\r\n        await refreshWhitelistToken(env, token, record, CONFIG.sessionTtl);\r\n    }\r\n\r\n    return jsonResponse({\r\n        ok: true,\r\n        scriptId: record.scriptId,\r\n        expiresIn: refresh ? CONFIG.sessionTtl : CONFIG.loaderWhitelistTtl,\r\n    });\r\n}\r\n\r\nfunction handleNotFound() {\r\n    return jsonResponse({ ok: false, reason: \"Not found\" }, { status: 404 });\r\n}\r\n\r\nexport default {\r\n    async fetch(request, env) {\r\n        const url = new URL(request.url);\r\n\r\n        if (request.method === \"OPTIONS\") {\r\n            return new Response(null, { status: 204 });\r\n        }\r\n\r\n        if (url.pathname === \"/\" || url.pathname === \"/loader\") {\r\n            return handleLoader(env);\r\n        }\r\n\r\n        if (url.pathname === \"/authorize\" && request.method === \"POST\") {\r\n            return handleAuthorize(request, env);\r\n        }\r\n\r\n        if (url.pathname === \"/validate\" && request.method === \"POST\") {\r\n            return handleValidate(request, env);\r\n        }\r\n\r\n        if (url.pathname === \"/health\") {\r\n            return handleHealth();\r\n        }\r\n\r\n        return handleNotFound();\r\n    },\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
